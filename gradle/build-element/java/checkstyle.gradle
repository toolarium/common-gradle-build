/*
 * checkstyle.gradle
 *
 * Copyright by toolarium, all rights reserved.
 * MIT License: https://mit-license.org
 */

 
/***************************************************************************************
 * Checkstyle configuraiton
 ***************************************************************************************/
if (project.hasProperty('initCheckstyle') && project.getProperty('initCheckstyle')) {
	def runtimeCheckstyleConfigurationPath = null

	// in case we have a global configuration and we only reference we don't have a local copy in the project
	if ((!project.hasProperty('projectIndividualCheckstyleConfiguration') || !project.getProperty('projectIndividualCheckstyleConfiguration'))
		&& project.hasProperty('commonGradleBuildHome') && project.hasProperty('commonGradleConfigPathName')) {
		def homeCheckstyleConfigurationPath = project.getProperty('commonGradleBuildHome') + "/" + project.getProperty('commonGradleConfigPathName') + "/checkstyle"
		
		if (new File(homeCheckstyleConfigurationPath).exists()) {
			setCommonGradleProperty("doCreateCheckstyleConfiguration", false)
			runtimeCheckstyleConfigurationPath = homeCheckstyleConfigurationPath
			setCommonGradleProperty("runtimeCheckstyleConfigurationPath", runtimeCheckstyleConfigurationPath)
			logInfo("Use reference checkstyle configuration " + colorize(HIGHLITE_LEVEL, runtimeCheckstyleConfigurationPath) + ".")
		}
	}	

	if (runtimeCheckstyleConfigurationPath==null) {
		setCommonGradleProperty("doCreateCheckstyleConfiguration", true)
		// work around: set the checkstyle as absolute path
		runtimeCheckstyleConfigurationPath = project.getProperty('checkstyleConfigurationPath')
		if (runtimeCheckstyleConfigurationPath.startsWith("./")) {
			runtimeCheckstyleConfigurationPath = cbProjectRootDir + "/" + checkstyleConfigurationPath.substring(2)
		}
		
		setCommonGradleProperty("runtimeCheckstyleConfigurationPath", runtimeCheckstyleConfigurationPath)
	}
	
	if (runtimeCheckstyleConfigurationPath!=null && !runtimeCheckstyleConfigurationPath.isEmpty() && new File("${runtimeCheckstyleConfigurationPath}/${checkstyleConfigurationFilename}").exists()) {
		apply plugin: 'checkstyle'
		
		checkstyle {
			maxWarnings = project.getProperty('checkstyleMaxWarnings')
			
			if (project.hasProperty('checkstyleToolVersion') && project.getProperty('checkstyleToolVersion')!=null && !project.getProperty('checkstyleToolVersion').isEmpty()) {
				toolVersion = project.getProperty('checkstyleToolVersion')
			}
			
			configProperties = [
					'samedir': runtimeCheckstyleConfigurationPath
				]
				
			logInfo("Checkstyle file " + colorize(HIGHLITE_LEVEL, "${runtimeCheckstyleConfigurationPath}/${checkstyleConfigurationFilename}") + ".")
			configFile file("${runtimeCheckstyleConfigurationPath}/${checkstyleConfigurationFilename}")
		}
		
		tasks.withType(Checkstyle) {
			reports {
				if (project.hasProperty('checkstyleXMLReport')) {
					xml.enabled project.getProperty('checkstyleXMLReport')
				} else {
					xml.enabled false
				}
				
				if (project.hasProperty('checkstyleHTMLReport')) {
					html.enabled project.getProperty('checkstyleHTMLReport')
				} else {
					html.enabled true
				}
				
				if (project.hasProperty('checkstyleCustomStylesheet')) {
					html.stylesheet resources.text.fromFile(project.getProperty('checkstyleCustomStylesheet'))
				}
			}
		}

		// define main directory
		checkstyleMain {
			source = project.getProperty('srcMainDirectory')
		}


		// define test directory
		checkstyleTest {
			source = project.getProperty('srcTestDirectory')
		}
	} else if (!project.getProperty('IS_NEW')) {
		printWarn("Could not load checkstyle configuration (${runtimeCheckstyleConfigurationPath})!")
	}
}


/***************************************************************************************
 * Project validation
 ***************************************************************************************/
projectValidation {
	doFirst {
		if (project.hasProperty('initCheckstyle') && project.getProperty('initCheckstyle')) {
			if (project.hasProperty('doCreateCheckstyleConfiguration') && project.getProperty('doCreateCheckstyleConfiguration')) {
				createCheckstyleConfiguration()
			}
		}
	}
}


/***************************************************************************************
 * Create checkstyle configuraiton
 ***************************************************************************************/
ext.createCheckstyleConfiguration = { overwrite = false ->
	def checkstyleFile = project.getProperty('checkstyleConfigurationFilename')
	if (overwrite || !new File("$checkstyleConfigurationPath/${checkstyleFile}").exists()) {
		def checkstyleConfigurationPath = project.getProperty('checkstyleConfigurationPath')	
		if (new File(checkstyleConfigurationPath).mkdirs()) {
			printInfo("> Created path " + colorize(HIGHLITE_LEVEL, checkstyleConfigurationPath) + ".")
		}
		
		if (!createFileFromTemplate("$checkstyleConfigurationPath/$checkstyleFile", getTemplateFile('checkstyle.xml.template', 'checkstyle'))) {
			printInfo("> No checkstyle configuration file found, ignore checkstyle.")
		} else if (!createFileFromTemplate("$checkstyleConfigurationPath/checkstyle-file-header.txt", getTemplateFile('checkstyle-file-header.txt.template', 'checkstyle'))) {
			printInfo("> No checkstyle configuration file found, ignore checkstyle.")
		} else  if (!createFileFromTemplate("$checkstyleConfigurationPath/checkstyle-suppressions.xml", getTemplateFile('checkstyle-suppressions.xml.template', 'checkstyle'))) {
			printInfo("> No checkstyle configuration file found, ignore checkstyle.")
		}
	}
}

