/*
 * version.gradle
 *
 * Copyright by toolarium, all rights reserved.
 * MIT License: https://mit-license.org
 */


/***************************************************************************************
 * Read version: see https://semver.org/ 
 ***************************************************************************************/
ext.readVersion = { ->
	// read version number
	logInfo("Read version file " + colorize(HIGHLITE_LEVEL, versionFile))

	def props = new Properties()	
	if (new File(versionFile).canRead()) {
		file(versionFile).withInputStream { props.load(it) }	
	} else {
		printWarn("Could not read version file " + colorize(HIGHLITE_LEVEL, versionFile))
	}
	
	def majorNumber = props.getProperty("major.number")
	if (majorNumber!=null) {
		setCommonGradleProperty('majorVersionNumber', parseInteger(majorNumber, 0, 'major.number'))
	}

	def minorNumber = props.getProperty("minor.number")
	if (minorNumber!=null) {
		setCommonGradleProperty('minorVersionNumber', parseInteger(minorNumber, 0, 'minor.number'))
	}
	
	def doUpdate = false
	def revisionNumber = props.getProperty("revision.number")
	if (revisionNumber!=null) {
		setCommonGradleProperty('revisionVersionNumber', parseInteger(revisionNumber, 1, 'revision.number'))
	} else {
		// keep backwards compatibility
		revisionNumber = props.getProperty("micro.number")
		if (revisionNumber!=null) {
			setCommonGradleProperty('revisionVersionNumber', parseInteger(revisionNumber, 1, 'revision.number'))
			doUpdate = true
		}
	}
	
	def qualifierNumber = props.getProperty("qualifier")
	if (qualifierNumber!=null) {
		setCommonGradleProperty('qualifierVersionNumber', qualifierNumber.trim(), '')
	} else {
		// keep backwards compatibility
		def buildNumber = props.getProperty("build.number")
		if (buildNumber!=null) {
			setCommonGradleProperty('qualifierVersionNumber', buildNumber.trim(), '')
			doUpdate = true
		}
	}	

	if (project.hasProperty('isReleaseVersion')) {
		if ("true".equalsIgnoreCase("" + project.getProperty('isReleaseVersion')) && project.getProperty('qualifierVersionNumber').endsWith(SNAPSHOT_TAG_NAME)) {
			qualifierVersionNumber=qualifierVersionNumber.replace(SNAPSHOT_TAG_NAME, "")
			doUpdate = true
		}
		
		if ("false".equalsIgnoreCase("" + project.getProperty('isReleaseVersion')) && !project.getProperty('qualifierVersionNumber').endsWith(SNAPSHOT_TAG_NAME)) {
			if (project.getProperty('qualifierVersionNumber').toString().trim().isEmpty()) {
				qualifierVersionNumber="${SNAPSHOT_TAG_NAME}"
			} else {
				qualifierVersionNumber="${qualifierVersionNumber}-${SNAPSHOT_TAG_NAME}"
			}
			doUpdate = true
		}
	}

	project.version = project.getProperty('majorVersionNumber') + "." + project.getProperty('minorVersionNumber') + "." + project.getProperty('revisionVersionNumber')
	def qualifierVersionNumber = project.getProperty('qualifierVersionNumber')
	if (qualifierVersionNumber !=null && !qualifierVersionNumber.isEmpty()) {
		project.version = project.version + "-" +  qualifierVersionNumber
	}

	if (!project.getProperty('qualifierVersionNumber').endsWith(SNAPSHOT_TAG_NAME)) {
		setCommonGradleProperty('isReleaseVersion', true, true, false)
		logInfo("It is a release verison: " + colorize(HIGHLITE_LEVEL, project.version))
	} else {
		setCommonGradleProperty('isReleaseVersion', false, false, false)
		logInfo("It is a snapshot verison: " + colorize(HIGHLITE_LEVEL, project.version))
	}

	setCommonGradleProperty('isSnapshotVersion', !project.getProperty('isReleaseVersion'))
	
	if (doUpdate) {
		updateVersion()
	}	
	
	return doUpdate
}


/***************************************************************************************
 * Update version
 ***************************************************************************************/
ext.updateVersion = { ->
	logInfo("Write file " + versionFile + " -> " + project.getProperty('majorVersionNumber') + ", " + project.getProperty('minorVersionNumber') + ", " + project.getProperty('revisionVersionNumber') + ", " + project.getProperty('qualifierVersionNumber'))
	new File(versionFile).withWriter { w ->
		w << "major.number        = " << project.getProperty('majorVersionNumber') << NELINE \
		<< "minor.number        = " << project.getProperty('minorVersionNumber') << NELINE \
		<< "revision.number     = " << project.getProperty('revisionVersionNumber') << NELINE \
		<< "qualifier           = " << project.getProperty('qualifierVersionNumber') << NELINE 
	}
}


/***************************************************************************************
 * Increase major version
 ***************************************************************************************/
ext.increaseMajorVersion = { ->
	setCommonGradleProperty('majorVersionNumber', 1 + project.getProperty('majorVersionNumber'), 1)
	setCommonGradleProperty('minorVersionNumber', 0, 0)
	setCommonGradleProperty('revisionVersionNumber', 0, 0)
	logInfo("Increase major number " + majorVersionNumber + ": " + project.version)
	updateVersion()
	readVersion()
}


/***************************************************************************************
 * Increase minor version
 ***************************************************************************************/
ext.increaseMinorVersion = { ->
	setCommonGradleProperty('minorVersionNumber', 1 + project.getProperty('minorVersionNumber'), 1)
	setCommonGradleProperty('revisionVersionNumber', 0, 0)
	logInfo("Increase minor number " + minorVersionNumber + ": " + project.version)
	updateVersion()
	readVersion()
}


/***************************************************************************************
 * Increase revision version
 ***************************************************************************************/
ext.increaseRevisionVersion = { ->
	setCommonGradleProperty('revisionVersionNumber', 1 + project.getProperty('revisionVersionNumber'), 1)
	logInfo("Increase revision number " + revisionVersionNumber + ": " + project.version)
	updateVersion()
	readVersion()
}
