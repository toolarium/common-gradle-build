/*
 * java-library.gradle
 *
 * Copyright by toolarium, all rights reserved.
 * MIT License: https://mit-license.org
 */

if (!project.hasProperty('commonGradleUrl')) {
    ext.commonGradleUrl='https://raw.githubusercontent.com/toolarium/common-gradle-build/master/gradle'
}

apply from: "${commonGradleUrl}/java-base.gradle"

// define default java directories
setCommonGradleDefaultPropertyIfNull("srcMainJavaDirectory", "${srcMainDirectory}/java")
setCommonGradleDefaultPropertyIfNull("srcMainResourcesDirectory", "${srcMainDirectory}/resources")
setCommonGradleDefaultPropertyIfNull("srcTestJavaDirectory", "${srcTestDirectory}/java")
setCommonGradleDefaultPropertyIfNull("srcTestResourcesDirectory", "${srcTestDirectory}/resources")


/***************************************************************************************
 * project java validation
 ***************************************************************************************/
projectValidation {
	doLast {
		if (project.getProperty('IS_NEW')) {
			logInfo("Create at least one java file...")
			def javaLibraryTemplate = 'javaLibrary.template'
			def slashedRootPackageName = rootPackageName.replace('.', '/')
			def className = 'MyLibrary'
			def commonGradleTemplateJavaPath = project.getProperty('commonGradleTemplateJavaPath')
			
			def mainJavaSourcPath = createPackagePath(srcMainJavaDirectory, rootPackageName)			
			if (new File("${commonGradleTemplateJavaPath}", "${javaLibraryTemplate}").exists()) {
				printInfo("> Create file " + colorize(HIGHLITE_LEVEL, "${mainJavaSourcPath}/${className}.java") + " from template ${javaLibraryTemplate}.")
				copy {
					from "${commonGradleTemplateJavaPath}"
					include "${javaLibraryTemplate}"
					into "${mainJavaSourcPath}"
					rename { String fileName -> fileName.replace("${javaLibraryTemplate}", "${className}.java".toString() ) }
					filter { line -> line.replaceAll('@@rootProject.name@@', "${rootProject.name}".toString()) }					
					filter { line -> line.replaceAll('@@className@@', "${className}".toString()) }
					filter { line -> line.replaceAll('@@fileName@@', "${className}.java".toString()) }
					filter { line -> line.replaceAll('@@packageName@@', "${rootPackageName}".toString()) }
					filter { line -> line.replaceAll('@@LICENSE@@', "${LICENSE}".toString()) }
				}
			} else {
				printInfo("> Create file " + colorize(HIGHLITE_LEVEL, "${mainJavaSourcPath}/${className}.java") + " with default values.")
				new File(mainJavaSourcPath, "${className}.java").withWriter { w ->
					w << "/*" << NELINE \
						<< " * ${className}.java" << NELINE \
						<< " *" << NELINE \
						<< " * Copyright by ${rootProject.name}, all rights reserved." << NELINE \
						<< " * ${LICENSE}" << NELINE \
						<< "*/" << NELINE \
						<< "package ${rootPackageName};" << NELINE \
						<< "" << NELINE \
						<< "" << NELINE \
						<< "/**" << NELINE \
						<< " * ${className}" << NELINE \
						<< " */" << NELINE \
						<< "public class ${className} {" << NELINE \
						<< "" << NELINE \
						<< "    /**" << NELINE \
						<< "     * Library method" << NELINE \
						<< "     */" << NELINE \
						<< "    public boolean someLibraryMethod() {" << NELINE \
						<< "        return true;" << NELINE \
						<< "    }" << NELINE \
						<< "}" << NELINE \
						<< "" << NELINE
				}			
			}
			
			def testJavaSourcPath = createPackagePath(srcTestJavaDirectory, rootPackageName)			
			def javaLibraryTestTemplate = 'javaLibraryTest.template'
			def testClassName = "${className}Test"
			if (new File("${commonGradleTemplateJavaPath}", "${javaLibraryTestTemplate}").exists()) {
				printInfo("> Create file " + colorize(HIGHLITE_LEVEL, "${testJavaSourcPath}/${testClassName}.java") + " from template ${javaLibraryTestTemplate}.")
				copy {
					from "${commonGradleTemplateJavaPath}"
					include "${javaLibraryTestTemplate}"
					into "${testJavaSourcPath}"
					rename { String fileName -> fileName.replace("${javaLibraryTestTemplate}", "${testClassName}.java".toString() ) }
					filter { line -> line.replaceAll('@@rootProject.name@@', "${rootProject.name}".toString()) }					
					filter { line -> line.replaceAll('@@className@@', "${testClassName}".toString()) }
					filter { line -> line.replaceAll('@@classNameUnderTest@@', "${className}".toString()) }				
					filter { line -> line.replaceAll('@@fileName@@', "${testClassName}.java".toString()) }
					filter { line -> line.replaceAll('@@packageName@@', "${rootPackageName}".toString()) }
					filter { line -> line.replaceAll('@@LICENSE@@', "${LICENSE}".toString()) }
				}
			} else {
				printInfo("> Create file " + colorize(HIGHLITE_LEVEL, "${testJavaSourcPath}/${testClassName}.java") + " with default values.")
				new File(testJavaSourcPath, "${testClassName}.java").withWriter { w ->
					w << "/*" << NELINE \
						<< " * ${testClassName}.java" << NELINE \
						<< " *" << NELINE \
						<< " * Copyright by ${rootProject.name}, all rights reserved." << NELINE \
						<< " * ${LICENSE}" << NELINE \
						<< "*/" << NELINE \
						<< "package ${rootPackageName};" << NELINE \
						<< "" << NELINE \
						<< "" << NELINE \
						<< "import org.junit.jupiter.api.Test;" << NELINE \
						<< "import static org.junit.jupiter.api.Assertions.*;" << NELINE \
						<< "" << NELINE \
						<< "" << NELINE \
						<< "/**" << NELINE \
						<< " * ${testClassName}" << NELINE \
						<< " */" << NELINE \
						<< "public class ${testClassName} {" << NELINE \
						<< "" << NELINE \
						<< "    /**" << NELINE \
						<< "     * Test ${className} method" << NELINE \
						<< "     */" << NELINE \
						<< "    @Test void testSomeLibraryMethod() {" << NELINE \
						<< "        ${className} classUnderTest = new ${className}();" << NELINE \
						<< "        assertTrue(classUnderTest.someLibraryMethod(), \"someLibraryMethod should return 'true'\");" << NELINE \
						<< "    }" << NELINE \
						<< "}" << NELINE \
						<< "" << NELINE
				}			
			}
		} 
	}
}
